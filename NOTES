;;Init
gcc -c nopcov.c

;;For every file
cp bzip2.c bzip2.bak

gcc -include nopcov.h -P -E -ansi -O0 bzip2.c > bzip2-preprocessed.c

nopcov bzip2-preprocessed.c

gcc -g -O0 -c -ansi bzip2-preprocessed-instrumented.c

gcc -o bzip2-nopcov bzip2-preprocessed-instrumented.o nopcov.o

mv bzip2-preprocessed-instrumented.c bzip2.c

;;Fin
rm *.o *-preprocessed.c *-instrumented.c

time ./bzip2-nopcov --keep --force 

;;Gcov
gcc -fprofile-arcs -ftest-coverage -g bzip2.c -o bzip2-gcov
time ./bzip2-gcov --keep --force 
gcov -c bzip2.c

;;Generate large text files
cat - > file.txt #with 2 lines
for i in {1..<n>}; do cat file.txt file.txt > file2.txt && mv file2.txt file.txt; done #for some n (25 about 400 mb)
